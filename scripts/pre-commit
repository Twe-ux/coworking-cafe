#!/bin/bash

# ============================================================================
# Pre-Commit Hook - Coworking Caf√©
# Emp√™che les commits contenant des secrets ou fichiers sensibles
# ============================================================================

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo -e "${GREEN}üîç V√©rification s√©curit√© pre-commit...${NC}"

# ----------------------------------------------------------------------------
# 1. Bloquer commits de fichiers .env.local
# ----------------------------------------------------------------------------

if git diff --cached --name-only | grep -E "\.env\.local$|\.env$"; then
    echo -e "${RED}‚ùå ERREUR: Tentative de commit d'un fichier .env${NC}"
    echo ""
    echo -e "${YELLOW}Fichiers bloqu√©s:${NC}"
    git diff --cached --name-only | grep -E "\.env\.local$|\.env$"
    echo ""
    echo "Les fichiers .env.local contiennent des secrets et ne doivent JAMAIS √™tre committ√©s."
    echo ""
    echo -e "${GREEN}Solution:${NC}"
    echo "  git reset HEAD <fichier>"
    echo "  git commit"
    echo ""
    exit 1
fi

# ----------------------------------------------------------------------------
# 2. D√©tecter secrets hardcod√©s dans les fichiers staged
# ----------------------------------------------------------------------------

SECRETS_FOUND=0

# Fonction pour v√©rifier un pattern dans les fichiers staged
check_secret_pattern() {
    local pattern=$1
    local description=$2
    
    # Rechercher dans les fichiers staged (uniquement ajouts, pas suppressions)
    local matches=$(git diff --cached --diff-filter=AM -U0 | grep -E "^\+" | grep -v "^+++" | grep -E "$pattern" | grep -v ".env.example" | grep -v "KEYS_TO_REGENERATE" | grep -v "placeholder" | grep -v "your-" | grep -v "xxxx")
    
    if [ ! -z "$matches" ]; then
        if [ $SECRETS_FOUND -eq 0 ]; then
            echo -e "${RED}‚ùå SECRETS D√âTECT√âS DANS LE CODE${NC}"
            echo ""
        fi
        SECRETS_FOUND=1
        echo -e "${YELLOW}‚ö†Ô∏è  $description${NC}"
        echo "$matches" | head -5
        echo ""
    fi
}

# V√©rifier diff√©rents patterns de secrets
check_secret_pattern "mongodb\+srv://[^:]+:[^@]+@" "MongoDB URI avec credentials"
check_secret_pattern "sk_test_[a-zA-Z0-9]{20,}" "Cl√© Stripe Test"
check_secret_pattern "sk_live_[a-zA-Z0-9]{20,}" "Cl√© Stripe Live"
check_secret_pattern "pk_test_[a-zA-Z0-9]{20,}" "Cl√© Publique Stripe Test"
check_secret_pattern "pk_live_[a-zA-Z0-9]{20,}" "Cl√© Publique Stripe Live"
check_secret_pattern "whsec_[a-zA-Z0-9]{20,}" "Webhook Secret Stripe"
check_secret_pattern "re_[a-zA-Z0-9]{20,}" "API Key Resend"
check_secret_pattern "AKIA[A-Z0-9]{16}" "AWS Access Key"
check_secret_pattern "['\"]secret['\"]:\s*['\"][a-zA-Z0-9]{32,}['\"]" "Secret g√©n√©rique > 32 caract√®res"

# Si des secrets ont √©t√© trouv√©s, bloquer le commit
if [ $SECRETS_FOUND -eq 1 ]; then
    echo -e "${RED}üö´ COMMIT BLOQU√â${NC}"
    echo ""
    echo "Des secrets ont √©t√© d√©tect√©s dans votre commit."
    echo "Ceci est interdit pour des raisons de s√©curit√©."
    echo ""
    echo -e "${GREEN}Solutions:${NC}"
    echo "  1. Utiliser des variables d'environnement (process.env.XXX)"
    echo "  2. Retirer les secrets du code"
    echo "  3. Utiliser des placeholders pour les exemples"
    echo ""
    echo "Si c'est un faux positif (ex: commentaire de documentation):"
    echo "  git commit --no-verify"
    echo "  (‚ö†Ô∏è  √Ä utiliser avec pr√©caution!)"
    echo ""
    exit 1
fi

# ----------------------------------------------------------------------------
# 3. Avertissement si fichiers sensibles modifi√©s
# ----------------------------------------------------------------------------

SENSITIVE_FILES=$(git diff --cached --name-only | grep -E "instrumentation\.ts$|mongodb\.ts$|stripe\.ts$")

if [ ! -z "$SENSITIVE_FILES" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Fichiers sensibles modifi√©s:${NC}"
    echo "$SENSITIVE_FILES"
    echo ""
    echo "V√©rifiez qu'aucun secret n'a √©t√© ajout√©."
    echo ""
fi

# ----------------------------------------------------------------------------
# Succ√®s
# ----------------------------------------------------------------------------

echo -e "${GREEN}‚úÖ V√©rification s√©curit√© pass√©e${NC}"
echo ""

exit 0
